# Example WKT workspace configuration
# Place this file as .wkt.yaml in your workspace directory
# Comprehensive example showing local files management AND script execution
#
# Configuration Hierarchy (higher priority overrides lower):
# 1. Workspace: .wkt.yaml in workspace directory (this file)
# 2. Project: ~/.wkt/config.yaml projects section
# 3. Global: ~/.wkt/config.yaml scripts section

local_files:
  # Files that will be symlinked to the main worktree
  # These files stay synchronized across all workspaces
  shared:
    - "CLAUDE.md"                    # AI context and instructions
    - ".cursor/rules"                # Cursor editor rules
    - "README-dev.md"                # Development documentation
    - "docs/contributing.md"         # Shared documentation
    - ".github/pull_request_template.md"

  # Files that will be copied from templates
  # These become workspace-specific after copying
  copied:
    - ".env.local"                   # Local environment variables
    - ".vscode/launch.json"          # Debug configurations
    - "docker-compose.override.yml"  # Local docker overrides

  # Template mappings (source -> target)
  # If not specified, copies from main worktree directly
  templates:
    ".env.local": ".env.local.example"
    ".vscode/launch.json": ".vscode/launch.json.template"
    "docker-compose.override.yml": "docker-compose.override.example.yml"

  # Workspace-specific template overrides
  # Pattern -> template mappings that apply when workspace/branch matches
  workspace_templates:
    # For any workspace with "staging" in the name
    "*staging*":
      ".env.local": ".env.staging.example"
      "docker-compose.override.yml":
        source: "docker-compose.staging.yml"
        variables:
          database_host: "staging-db.example.com"
          api_url: "https://api-staging.example.com"
    
    # For production branches/workspaces  
    "*production*":
      ".env.local": ".env.production.example"
      "docker-compose.override.yml":
        source: "docker-compose.prod.yml"
        conditions:
          branch_pattern: "^(main|master|release/.*)$"
        variables:
          database_host: "prod-db.example.com"
          api_url: "https://api.example.com"
    
    # For feature branches
    "feature/*":
      ".env.local":
        source: ".env.dev.example"
        variables:
          feature_flag: "true"
          debug_mode: "true"
          workspace_id: "{{workspace_name}}"
    
    # For hotfix branches - use production-like settings
    "hotfix/*":
      ".env.local":
        source: ".env.prod.example"
        conditions:
          branch_pattern: "^hotfix/.*"
        variables:
          debug_mode: "false"
          log_level: "warn"

# Project-specific git settings
git:
  default_base: "main"
  auto_fetch: true
  push_on_create: false

# Workspace naming strategy
workspace:
  naming_strategy: "sanitized"     # or "kebab-case", "snake_case"
  auto_cleanup: true
  max_age_days: 30

# Branch name inference patterns
inference:
  patterns:
    - pattern: '^(\d+)$'
      template: 'feature/eng-{}'
    - pattern: '^(feature/.+)$'
      template: '{}'
    - pattern: '^(bugfix/.+)$'
      template: '{}'

# Script execution configuration (SAFE)
# These scripts will be merged with global and project-level scripts
# Workspace-specific scripts have the highest priority
scripts:
  # Security: Only allow these commands to be executed
  allowed_commands:
    - "pnpm"
    - "npm"
    - "yarn"
    - "bun"
    - "node"
    - "git"
    - "docker"
    - "docker-compose"
    - "planetscale"         # For database branch management
    - "pscale"             # PlanetScale CLI alternative name
    - "make"
    - "jq"                 # For JSON manipulation
    - "sh"                 # Shell commands
    - "mv"                 # File operations
    - "./scripts/"         # Local scripts in scripts/ directory
    - "scripts/"           # Alternative path

  # Workspace-specific scripts (only available in this workspace)
  scripts:
    workspace-setup:
      name: "Workspace Setup"
      command: ["sh", "-c", "echo 'Setting up workspace-specific configuration'"]
      description: "Configure this specific workspace"
      timeout: 60000  # 1 minute

    theme-dark:
      name: "Set Dark Theme"
      command: ["sh", "-c", "jq '. + {\"workbench.colorTheme\": \"Dark Modern\"}' .vscode/settings.json > tmp.json && mv tmp.json .vscode/settings.json"]
      description: "Set VS Code to Dark Modern theme"
      conditions:
        file_exists: [".vscode/settings.json"]

    theme-light:
      name: "Set Light Theme"
      command: ["sh", "-c", "jq '. + {\"workbench.colorTheme\": \"Default Light Modern\"}' .vscode/settings.json > tmp.json && mv tmp.json .vscode/settings.json"]
      description: "Set VS Code to Light Modern theme"
      conditions:
        file_exists: [".vscode/settings.json"]

    install-deps:
      name: "Install Dependencies"
      command: ["pnpm", "install"]
      description: "Install npm dependencies"
      conditions:
        file_exists: ["package.json"]
      timeout: 300000  # 5 minutes

    build-project:
      name: "Build Project"  
      command: ["pnpm", "run", "build"]
      description: "Build the project"
      conditions:
        file_exists: ["package.json"]
      timeout: 600000  # 10 minutes
      
    setup-cursor-theme:
      name: "Setup Cursor Theme"
      command: ["./scripts/setup-cursor-theme.sh", "{{workspace_name}}"]
      description: "Configure workspace-specific Cursor theme"
      conditions:
        file_exists: ["scripts/setup-cursor-theme.sh"]
      optional: true
        
    create-db-branch:
      name: "Create Database Branch"
      command: ["pscale", "branch", "create", "{{project_name}}", "{{branch_name}}"]
      description: "Create PlanetScale database branch matching git branch"
      conditions:
        file_exists: [".env.local", "planetscale.yml"]
      optional: true

    setup-docker-env:
      name: "Setup Docker Environment"
      command: ["docker-compose", "up", "-d"]
      description: "Start Docker development environment"
      conditions:
        file_exists: ["docker-compose.yml"]
      optional: true
      background: true

    # Container lifecycle scripts for workspace isolation
    # These enable per-workspace containers (Docker, Podman, OrbStack, etc.)
    docker-up:
      name: "Start Containers"
      command: ["docker", "compose", "-p", "{{workspace_name}}", "up", "-d"]
      description: "Start workspace-specific containers with isolated project name"
      conditions:
        file_exists: ["docker-compose.yml"]
      optional: true
      env:
        COMPOSE_PROJECT_NAME: "{{workspace_name}}"

    docker-down:
      name: "Stop Containers"
      command: ["docker", "compose", "-p", "{{workspace_name}}", "down"]
      description: "Stop workspace-specific containers"
      conditions:
        file_exists: ["docker-compose.yml"]
      optional: true
      env:
        COMPOSE_PROJECT_NAME: "{{workspace_name}}"

    docker-logs:
      name: "Container Logs"
      command: ["docker", "compose", "-p", "{{workspace_name}}", "logs", "-f"]
      description: "Follow logs from workspace containers"
      conditions:
        file_exists: ["docker-compose.yml"]
      env:
        COMPOSE_PROJECT_NAME: "{{workspace_name}}"

    cleanup-db-branch:
      name: "Cleanup Database Branch"
      command: ["pscale", "branch", "delete", "{{project_name}}", "{{branch_name}}", "--force"]
      description: "Delete PlanetScale database branch when cleaning workspace"
      conditions:
        file_exists: ["planetscale.yml"]
      optional: true

  # Scripts that run automatically during workspace lifecycle
  # Available hooks:
  #   - post_create: After workspace is created
  #   - pre_switch: Before switching AWAY from a workspace (teardown)
  #   - post_switch: After switching TO a workspace (setup)
  #   - pre_clean: Before a workspace is removed (cleanup)
  #   - post_clean: After a workspace is removed (external cleanup)
  hooks:
    post_create:
      - script: "install-deps"
      - script: "build-project"
        conditions:
          file_missing: ["dist/"]  # Only build if dist doesn't exist
      - script: "setup-cursor-theme"
      - script: "create-db-branch"
        variables:
          branch_name: "{{workspace_name}}"  # Use workspace name for DB branch
      - script: "docker-up"  # Start containers after creating workspace

    # Container lifecycle: stop services when switching away
    pre_switch:
      - script: "docker-down"
        optional: true  # Don't fail if containers aren't running

    # Container lifecycle: start services when switching to workspace
    post_switch:
      - script: "docker-up"
        optional: true

    # Cleanup before removing workspace
    pre_clean:
      - script: "docker-down"
        optional: true
      - script: "cleanup-db-branch"
        optional: true

  # Named shortcuts for convenience
  shortcuts:
    i: "install-deps"
    build: "build-project"
    db: "create-db-branch"
    docker: "setup-docker-env"
    up: "docker-up"
    down: "docker-down"
    logs: "docker-logs"

  # Workspace-specific script overrides
  # Patterns can match workspace name or branch name
  # All lifecycle hooks (post_create, pre_switch, post_switch, pre_clean, post_clean) can be workspace-specific
  workspace_scripts:
    # Feature branches get additional development setup
    "feature/*":
      post_create:
        - script: "install-deps"
        - script: "setup-cursor-theme"
        - script: "create-db-branch"
          variables:
            branch_name: "dev-{{workspace_name}}"
        - script: "docker-up"
      pre_switch:
        - script: "docker-down"
          optional: true
      post_switch:
        - script: "docker-up"
          optional: true
      pre_clean:
        - script: "docker-down"
          optional: true
        - script: "cleanup-db-branch"
          optional: true
      scripts:
        dev-server:
          name: "Development Server"
          command: ["pnpm", "run", "dev"]
          description: "Start development server with hot reload"
          background: true

    # Staging workspaces use different database and containers
    "*staging*":
      post_switch:
        - script: "docker-up"
          optional: true
      pre_switch:
        - script: "docker-down"
          optional: true
      scripts:
        create-db-branch:
          name: "Create Staging Database Branch"
          command: ["pscale", "branch", "create", "{{project_name}}", "staging-{{workspace_name}}"]
          description: "Create staging database branch"

    # Production-like branches need special handling
    "hotfix/*":
      post_create:
        - script: "install-deps"
        # Skip automatic containers for hotfixes - manual verification required
      scripts:
        create-db-branch:
          name: "Create Hotfix Database Branch"
          command: ["pscale", "branch", "create", "{{project_name}}", "hotfix-{{workspace_name}}"]
          description: "Create hotfix database branch"

# Additional script examples for common use cases
  
  # AI/Development workflow scripts
  scripts:
    setup-ai-context:
      name: "Setup AI Development Context"
      command: ["./scripts/setup-ai-context.sh", "{{workspace_name}}", "{{branch_name}}"]
      description: "Configure AI tools (Cursor, etc.) for this workspace"
      conditions:
        file_exists: ["scripts/setup-ai-context.sh"]
      optional: true

    sync-terminal-theme:
      name: "Sync Terminal Theme"
      command: ["./scripts/sync-terminal-theme.sh", "{{project_name}}", "{{workspace_name}}"]
      description: "Update terminal/shell theme to match workspace"
      conditions:
        file_exists: ["scripts/sync-terminal-theme.sh"]
      optional: true
      background: true

    run-tests:
      name: "Run Test Suite"
      command: ["pnpm", "run", "test"]
      description: "Run all tests"
      conditions:
        file_exists: ["package.json"]
      timeout: 600000  # 10 minutes

    clean-build:
      name: "Clean and Build"
      command: ["pnpm", "run", "clean", "&&", "pnpm", "run", "build"]
      description: "Clean previous build and rebuild"
      conditions:
        file_exists: ["package.json"]
      timeout: 900000  # 15 minutes

  # Database management scripts
    reset-database:
      name: "Reset Development Database"
      command: ["./scripts/reset-dev-db.sh", "{{workspace_name}}"]
      description: "Reset database to clean state for development"
      conditions:
        file_exists: ["scripts/reset-dev-db.sh", ".env.local"]
      optional: true

    migrate-database:
      name: "Run Database Migrations"
      command: ["pnpm", "run", "db:migrate"]
      description: "Apply pending database migrations"
      conditions:
        file_exists: ["package.json"]
      optional: true

  # Additional shortcuts for convenience
  shortcuts:
    t: "run-tests"
    clean: "clean-build"
    reset: "reset-database"
    migrate: "migrate-database"
    theme: "theme-dark"
    light: "theme-light"
    setup: "workspace-setup"

# Usage Examples:
# - Interactive selection: `wkt run` (shows all available scripts)
# - Direct execution: `wkt run theme-dark`
# - Shortcut usage: `wkt run theme` (runs theme-dark)
# - List all scripts: `wkt run list`
# - Dry run: `wkt run workspace-setup --dry`